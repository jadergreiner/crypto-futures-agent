name: üìã DOC Governance Validation

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'BEST_PRACTICES.md'
      - '.github/workflows/docs-validate.yml'
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'BEST_PRACTICES.md'

jobs:
  markdown-lint:
    name: üìù Markdownlint (80 char, UTF-8)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Instalar markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Rodar markdownlint
        run: |
          echo "üîç Validando markdown..."
          markdownlint \
            --config .markdownlintrc.json \
            docs/**/*.md \
            README.md \
            BEST_PRACTICES.md \
            2>&1 | tee markdown-report.txt || {
            echo "‚ùå Markdownlint falhou!"
            echo ""
            echo "Regras aplicadas:"
            echo "  ‚Ä¢ M√°ximo 80 caracteres por linha"
            echo "  ‚Ä¢ UTF-8 v√°lido (sem caracteres corrompidos)"
            echo "  ‚Ä¢ Code blocks requerem language declaration (```python, ```bash, etc)"
            echo "  ‚Ä¢ T√≠tulos descritivos (n√£o vazios)"
            echo ""
            exit 1
          }
          echo "‚úÖ Markdownlint passou!"

      - name: Upload markdown report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: markdown-lint-report
          path: markdown-report.txt

  python-docstring-check:
    name: üêç Python Docstring Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Verificar docstrings (agent/, execution/, risk/, backtest/)
        run: |
          echo "üîç Validando docstrings em Python..."
          MISSING_DOCSTRINGS=0

          for dir in agent execution risk backtest; do
            if [ -d "$dir" ]; then
              for file in $(find $dir -name "*.py" -type f | grep -v test | grep -v __pycache__); do
                # Check se arquivo tem >20 linhas e primeira n√£o tem docstring
                lines=$(wc -l < "$file")
                if [ "$lines" -gt 20 ]; then
                  head -n 5 "$file" | grep -q '"""' || {
                    echo "‚ùå Docstring faltando: $file"
                    MISSING_DOCSTRINGS=$((MISSING_DOCSTRINGS + 1))
                  }
                fi
              done
            fi
          done

          if [ "$MISSING_DOCSTRINGS" -gt 0 ]; then
            echo ""
            echo "‚ùå $MISSING_DOCSTRINGS arquivo(s) com docstring faltando!"
            echo "Requirement: agent/, execution/, risk/, backtest/ requerem docstring"
            echo "Format: \"\"\"Descri√ß√£o breve do m√≥dulo.\"\"\""
            exit 1
          fi
          echo "‚úÖ Python docstrings: OK"

  sync-tag-requirement:
    name: üìå [SYNC] Tag Requirement
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Verificar [SYNC] tag em commits
        run: |
          echo "üîç Validando [SYNC] tags em PR..."

          # Pega o merge base
          MERGE_BASE=$(git merge-base origin/${{ github.base_ref }} HEAD)

          # Commits no PR
          COMMITS=$(git rev-list $MERGE_BASE..HEAD)

          MISSING_SYNC=0
          for commit in $COMMITS; do
            MSG=$(git log -1 --format=%B $commit)

            # Verifica se commit alterou arquivos cr√≠ticos
            CRITICAL=$(git diff-tree --no-commit-id --name-only -r $commit | \
              grep -E '(^docs/|^README|^BEST_PRACTICES|^\.github/workflows)' || true)

            if [ -n "$CRITICAL" ]; then
              if ! echo "$MSG" | grep -q "\[SYNC\]"; then
                echo "‚ùå Commit sem [SYNC] tag detectado:"
                echo "   Hash: $commit"
                echo "   Msg: $(echo $MSG | head -n1)"
                echo "   Files: $CRITICAL"
                MISSING_SYNC=$((MISSING_SYNC + 1))
              fi
            fi
          done

          if [ "$MISSING_SYNC" -gt 0 ]; then
            echo ""
            echo "‚ùå $MISSING_SYNC commit(s) alterou docs mas SEM [SYNC] tag!"
            echo "Requirement: [SYNC] tag obrigat√≥ria em commits que alteram docs"
            echo "Format: [SYNC] Descri√ß√£o ‚Äî mudan√ßas de docs"
            exit 1
          fi
          echo "‚úÖ [SYNC] tags: OK"

  synchronization-md-entry:
    name: üìñ SYNCHRONIZATION.md Entry
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3

      - name: Verificar entry em SYNCHRONIZATION.md para mudan√ßas cr√≠ticas
        run: |
          echo "üîç Validando entry em docs/SYNCHRONIZATION.md..."

          # Se h√° mudan√ßas em arquivos cr√≠ticos, deve haver entry em SYNCHRONIZATION
          CRITICAL_FILES=$(git diff origin/${{ github.base_ref }}...HEAD --name-only | \
            grep -E '(^docs/EQUIPE|^docs/ARCHITECTURE|^README|^BEST_PRACTICES)' || true)

          if [ -n "$CRITICAL_FILES" ]; then
            # Check se SYNCHRONIZATION.md foi alterado neste PR
            if ! git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -q "docs/SYNCHRONIZATION.md"; then
              echo "‚ö†Ô∏è  Mudan√ßa em arquivo cr√≠tico detectada, mas docs/SYNCHRONIZATION.md n√£o foi atualizado."
              echo "   Arquivos: $CRITICAL_FILES"
              echo "   Sugest√£o: Adicione entry em docs/SYNCHRONIZATION.md com timestamp e descri√ß√£o."
              echo "   Obs: Esta √© um WARNING, n√£o bloqueia merge (mas DOC Advocate debe reviewar)"
            fi
          fi
          echo "‚úÖ SYNCHRONIZATION.md: Validated"

  encoding-check:
    name: üî§ UTF-8 Encoding Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Validar UTF-8 em todos os .md
        run: |
          echo "üîç Validando UTF-8 encoding..."
          INVALID_ENCODING=0

          for file in $(find docs -name "*.md" -o -name "README.md" -o -name "BEST_PRACTICES.md"); do
            if ! iconv -f UTF-8 -t UTF-8 "$file" > /dev/null 2>&1; then
              echo "‚ùå Encoding inv√°lido: $file"
              INVALID_ENCODING=$((INVALID_ENCODING + 1))
            fi
          done

          if [ "$INVALID_ENCODING" -gt 0 ]; then
            echo "‚ùå $INVALID_ENCODING arquivo(s) com encoding inv√°lido!"
            exit 1
          fi
          echo "‚úÖ UTF-8 Encoding: OK"

  report:
    name: üìä Docs Validation Report
    runs-on: ubuntu-latest
    if: always()
    needs: [ markdown-lint, python-docstring-check, encoding-check ]
    steps:
      - name: Check results
        run: |
          echo "üìä DOC GOVERNANCE VALIDATION REPORT"
          echo "===================================="
          echo ""
          echo "‚úÖ Markdownlint:           ${{ needs.markdown-lint.result }}"
          echo "‚úÖ Python Docstrings:     ${{ needs.python-docstring-check.result }}"
          echo "‚úÖ UTF-8 Encoding:        ${{ needs.encoding-check.result }}"
          echo ""
          if [ "${{ needs.markdown-lint.result }}" = "failure" ] || \
             [ "${{ needs.python-docstring-check.result }}" = "failure" ] || \
             [ "${{ needs.encoding-check.result }}" = "failure" ]; then
            echo "‚ùå VALIDA√á√ÉO FALHOU"
            exit 1
          fi
          echo "‚úÖ VALIDA√á√ÉO COMPLETA ‚Äî Pronto para merge"
