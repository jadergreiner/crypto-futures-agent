# ğŸ“ Data Architecture Diagram â€” 1 Year Backtesting Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BINANCE FUTURES API (Rate-Limited: <1200 req/min)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ GET /fapi/v1/klines
                       â”‚ symbol, interval=4h, limit=1500
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KLINES FETCHER (klines_cache_manager.py)                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ â€¢ Respeita rate limits (backoff exponencial 429)                   â”‚  â”‚
â”‚ â”‚ â€¢ Batches 1500 candles/req, sequencial por sÃ­mbolo               â”‚  â”‚
â”‚ â”‚ â€¢ ~88 reqs totais para 60 sÃ­mbolos Ã— 1 ano                       â”‚  â”‚
â”‚ â”‚ â€¢ DuraÃ§Ã£o: 15-20 minutos                                         â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Raw klines: [[open_time, open, high, low, close, volume, ...], ...]
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATA VALIDATOR (Integridade)                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ â€¢ LÃ³gica de preÃ§os: low â‰¤ open,close â‰¤ high                      â”‚  â”‚
â”‚ â”‚ â€¢ Volume nÃ£o-negativo                                             â”‚  â”‚
â”‚ â”‚ â€¢ Timestamps monotÃ´nico, duraÃ§Ã£o 4h exata                        â”‚  â”‚
â”‚ â”‚ â€¢ Gap detection (candles sequenciais)                             â”‚  â”‚
â”‚ â”‚ â€¢ Trades > 0 (candle nÃ£o-vazio)                                  â”‚  â”‚
â”‚ â”‚                                                                    â”‚  â”‚
â”‚ â”‚ Resultado: âœ… PASS | ğŸŸ¡ WARN (90-99%) | âŒ FAIL (<90%)           â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Validated klines
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CACHE MANAGER (SQLite Persistence)                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚                    data/klines_cache.db (~650 KB)                  â”‚  â”‚
â”‚ â”‚                                                                    â”‚  â”‚
â”‚ â”‚  Table: klines                                                     â”‚  â”‚
â”‚ â”‚  â”œâ”€ id (PRIMARY KEY)                                              â”‚  â”‚
â”‚ â”‚  â”œâ”€ symbol, open_time (UNIQUE + INDEX)                           â”‚  â”‚
â”‚ â”‚  â”œâ”€ OHLCV + trades, volumes                                       â”‚  â”‚
â”‚ â”‚  â”œâ”€ is_validated (boolean, indexed)                               â”‚  â”‚
â”‚ â”‚  â”œâ”€ sync_timestamp                                                â”‚  â”‚
â”‚ â”‚  â””â”€ CHECK constraints (price logic)                               â”‚  â”‚
â”‚ â”‚                                                                    â”‚  â”‚
â”‚ â”‚  Table: sync_log                                                   â”‚  â”‚
â”‚ â”‚  â”œâ”€ symbol, sync_type (FULL|DAILY|INCREMENTAL)                   â”‚  â”‚
â”‚ â”‚  â”œâ”€ rows_inserted, rows_updated, status                           â”‚  â”‚
â”‚ â”‚  â””â”€ sync_timestamp (audit trail)                                  â”‚  â”‚
â”‚ â”‚                                                                    â”‚  â”‚
â”‚ â”‚ + Backup: klines_cache_*.parquet (snapshot diÃ¡rio)                â”‚  â”‚
â”‚ â”‚ + Metadata: klines_meta.json                                      â”‚  â”‚
â”‚ â”‚ + Report: integrity_report_*.json                                 â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Query: SELECT ... FROM klines WHERE symbol = ? AND is_validated = 1
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKTEST DATA LOADER (backtest/data_loader.py)                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ BacktestDataLoader                                                 â”‚  â”‚
â”‚ â”‚ â”œâ”€ load_symbol_range(symbol, start, end) â†’ DataFrame float32     â”‚  â”‚
â”‚ â”‚ â”œâ”€ load_portfolio_range(symbols, start, end) â†’ Dict[str, DF]     â”‚  â”‚
â”‚ â”‚ â””â”€ Otimizado para numpy operations (SMC)                          â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 131.400 candles (60 Ã— 2190)
                       â”‚ dtype: float32 â†’ ~250 MB memory
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SMC BACKTESTING (agent/backtest.py)                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Executa histÃ³rico de trading em ~2190 timeframes                   â”‚  â”‚
â”‚ â”‚ Valida: profitabilidade, sharpe, drawdown, tax efficiency        â”‚  â”‚
â”‚ â”‚ Output: backtest_results.json + trades_log.csv                    â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Ciclo de Vida dos Dados

```
[Setup] â†’ [Initial Full Fetch] â†’ [Daily Sync] â†’ [Pre-Backtest] â†’ [Backtest Exec]
  5min       15-20 min              <5 min         <30 sec         Variable
   â†“             â†“                    â†“              â†“               â†“
   â–¡             â–¡                    â–¡              â–¡               â–¡
 Config      1 ano inteiro       Ãšltimos 7d     Ãšltimas 12h      HistÃ³rico
 criado      em disco             refresh      atualizado        analisado
```

---

## ğŸ“Š Recursos Consumidos

| Recurso | Consumo | Notas |
|---------|---------|-------|
| **Disco** | ~650 KB (DB) + 100 KB (metadata) | CompactaÃ§Ã£o ~80% |
| **MemÃ³ria** | ~250 MB (DataFrames float32) | Por-demand ao carregar |
| **Band. Binance** | 88 reqs, ~1200 KB data | 1Ã— setup, depois negligenciÃ¡vel |
| **Rate Limit** | 88/1200 (7%) | Respeitado com backoff automÃ¡tico |
| **Tempo (setup)** | 15-20 min | Pre-requisito, 1Ã— stage |
| **Tempo (daily)** | <5 min | Automatizado cron |
| **Tempo (pre-backtest)** | <30 seg | Incremental apenas |

---

## ğŸ” ValidaÃ§Ãµes de SeguranÃ§a

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ValidaÃ§Ãµes de Integridade               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… PreÃ§o: low â‰¤ open,close â‰¤ high      â”‚
â”‚ âœ… Volume: â‰¥ 0 (nÃ£o-negativo)          â”‚
â”‚ âœ… Tempo: open < close, exato 4h       â”‚
â”‚ âœ… Sequence: sem gaps, monÃ³t. crescenteâ”‚
â”‚ âœ… Trades: > 0 (candle vÃ¡lido)         â”‚
â”‚ âœ… CRC32: detecÃ§Ã£o de corrupÃ§Ã£o        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CritÃ©rio de sucesso: â‰¥99% integrity pass rate
Fallback: Revalidar + re-download se <95%
```

---

## ğŸ¯ Checkpoints de Monitoramento

```python
# 1. ApÃ³s Full Fetch
assert db_cursor.execute("SELECT COUNT(*) FROM klines").fetchone()[0] >= 131300
assert integrity_report["BTCUSDT"]["status"] == "PASS"

# 2. Antes de Backtest
loader = BacktestDataLoader()
btc = loader.load_symbol_range("BTCUSDT", 1year_ago, now)
assert len(btc) >= 2180  # TolerÃ¢ncia 10 candles
assert btc.dtypes["close"] == np.float32

# 3. Durante Backtest
assert smc_result["trades"] > 0
assert smc_result["sharpe"] is not None
```

---

## ğŸ“¡ Fluxo de SincronizaÃ§Ã£o AutomÃ¡tica

```
15:30 [Setup] â”€â”€â”€â”€â”€> Full Fetch (60 sÃ­mbols, 1 ano)
         â”‚
         â””â”€â”€> âœ… 131.400 candles em disk
                    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                         â–¼
    [Daily @ 04:00]            [Incremental]
         â”‚                         â”‚
         â””â”€> Resync 7d           â””â”€> Antes SMC
             <5 min                 <30s
             Tolerance check        Update recent
             Gap detection          Ready for backtest
             Audit trail
```

---

**Fonte:** Data Strategy Document (DATA_STRATEGY_BACKTESTING_1YEAR.md)  
**ImplementaÃ§Ã£o:** klines_cache_manager.py (Production Ready)  
**Setup Guide:** DATA_PIPELINE_QUICK_START.md  
**ProprietÃ¡rio:** Data Engineer (#11)
