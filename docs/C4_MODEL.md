# ğŸ›ï¸ C4 Model â€” Crypto Futures Agent

**VersÃ£o:** 0.3.0
**Data:** 28 FEV 2026
**ResponsÃ¡vel:** Arkurat (#6)

---

## NÃ­vel 1: Contexto (System Context Diagram)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       OPERADOR                           â”‚
â”‚              (Gestor de Trading, Board)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚             â”‚
        â–¼             â–¼             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Iniciarâ”‚  â”‚  Dashboardâ”‚  â”‚  Telegramâ”‚
    â”‚.bat    â”‚  â”‚  Web UI   â”‚  â”‚ Alerts   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  CRYPTO FUTURES AGENT (APP)    â”‚
        â”‚                                â”‚
        â”‚ â€¢ SMC Analysis                 â”‚
        â”‚ â€¢ PPO Model Inference          â”‚
        â”‚ â€¢ Order Execution              â”‚
        â”‚ â€¢ Risk Management              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚             â”‚
        â–¼             â–¼             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Binance  â”‚ â”‚ SQLite   â”‚ â”‚ Parquet  â”‚
    â”‚Futures   â”‚ â”‚ Cache    â”‚ â”‚ Snapshotsâ”‚
    â”‚API (REST)â”‚ â”‚ (Local)  â”‚ â”‚ (S3)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**DescriÃ§Ã£o:**

- **Operador:** Interage via iniciar.bat, dashboard ou alerts Telegram
- **Sistema Central:** Orquestra anÃ¡lise SMC + ML inference + execuÃ§Ã£o
- **Dados:** Armazena cache local (SQLite) + snapshots (Parquet)
- **Exchange:** Sincroniza com Binance Futures REST API em tempo real

---

## NÃ­vel 2: Containers (Technical Architecture)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLIENTE / INTERFACE                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  iniciar.bat   â”‚  â”‚  menu.py    â”‚  â”‚  dashboard   â”‚     â”‚
â”‚  â”‚  (Batch)       â”‚  â”‚  (CLI)      â”‚  â”‚  (Web)       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTP / CLI
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               PYTHON APPLICATION (crypto-futures-agent)     â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STRATEGY LAYER                                       â”‚  â”‚
â”‚  â”‚  â€¢ smc_analyzer.py (Order Blocks + BoS)             â”‚  â”‚
â”‚  â”‚  â€¢ rl_agent.py (PPO Model Inference)                â”‚  â”‚
â”‚  â”‚  â€¢ heuristics.py (Multi-timeframe Validation)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ EXECUTION LAYER                                      â”‚  â”‚
â”‚  â”‚  â€¢ order_executor.py (Place / Cancel)               â”‚  â”‚
â”‚  â”‚  â€¢ position_manager.py (LIFO Closing)               â”‚  â”‚
â”‚  â”‚  â€¢ trailing_stop_manager.py (Dynamic SL)            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ DATA LAYER                                           â”‚  â”‚
â”‚  â”‚  â€¢ klines_cache_manager.py (1Y Ã— 60 Symbols)        â”‚  â”‚
â”‚  â”‚  â€¢ risk/risk_gates.py (Capital + Leverage Checks)   â”‚  â”‚
â”‚  â”‚  â€¢ backtest/backtester.py (Historical Simulation)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ PERSISTENCE LAYER                                    â”‚  â”‚
â”‚  â”‚  â€¢ SQLite (Local Cache): 650 KB                      â”‚  â”‚
â”‚  â”‚  â€¢ Parquet (Snapshots): 580 KB                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ REST API              â”‚ File I/O
                   â–¼                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ BINANCE FUTURES  â”‚    â”‚ LOCAL FILESYSTEM    â”‚
        â”‚                  â”‚    â”‚                     â”‚
        â”‚ /fapi/v1/klines  â”‚    â”‚ ./data/             â”‚
        â”‚ /fapi/v1/order   â”‚    â”‚ ./logs/             â”‚
        â”‚ /fapi/v1/account â”‚    â”‚ ./config/           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Componentes:**

1. **Cliente:** iniciar.bat (batch) â†’ menu.py (CLI) â†’ dashboard (web)
2. **AplicaÃ§Ã£o Python:** 4 camadas lÃ³gicas (Strategy, Execution, Data, Persistence)
3. **Externos:** Binance API + Sistema de Arquivos Local

---

## NÃ­vel 3: Componentes (Detailed Components)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STRATEGY LAYER                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  SMCAnalyzer â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚    â”‚                         â”‚                          â”‚
â”‚    â”œâ”€â–º Order Block Detection â”‚                          â”‚
â”‚    â”œâ”€â–º Break of Structure     â”‚ Feedback Loop          â”‚
â”‚    â””â”€â–º Volume Validation      â”‚                          â”‚
â”‚                               â”‚                          â”‚
â”‚  HeuristicValidator â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
â”‚    â”‚                           â”‚                          â”‚
â”‚    â”œâ”€â–º Multi-timeframe (D1/H4/H1)                       â”‚
â”‚    â”œâ”€â–º RSI/ADX/EMA Indicators                           â”‚
â”‚    â””â”€â–º Signal Confidence Scoring                        â”‚
â”‚                               â”‚                          â”‚
â”‚  RLAgent (PPO Model) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
â”‚    â”‚                           â”‚                          â”‚
â”‚    â”œâ”€â–º Inference on Candidates â”‚                          â”‚
â”‚    â”œâ”€â–º Confidence 0.0â€“1.0 Output                        â”‚
â”‚    â””â”€â–º Model Version Management â”‚                          â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EXECUTION LAYER                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  RiskGates                                              â”‚
â”‚    â”œâ”€â–º Capital Available Check                          â”‚
â”‚    â”œâ”€â–º Leverage Validation (â‰¤ 3Ã—)                       â”‚
â”‚    â”œâ”€â–º Portfolio Drawdown Check (-5% threshold)         â”‚
â”‚    â””â”€â–º GO / NO-GO Decision                              â”‚
â”‚          â”‚                                              â”‚
â”‚          â–¼                                              â”‚
â”‚  OrderExecutor                                          â”‚
â”‚    â”œâ”€â–º Place LIMIT Order (Binance)                      â”‚
â”‚    â”œâ”€â–º Fill Status Tracking                             â”‚
â”‚    â””â”€â–º Cancel Logic (if needed)                         â”‚
â”‚          â”‚                                              â”‚
â”‚          â–¼                                              â”‚
â”‚  PositionManager                                        â”‚
â”‚    â”œâ”€â–º LIFO Tracking (Last-In-First-Out)               â”‚
â”‚    â”œâ”€â–º P&L Calculation                                 â”‚
â”‚    â”œâ”€â–º SL/TP Management                                â”‚
â”‚    â””â”€â–º Closing Orchestration                            â”‚
â”‚                                                         â”‚
â”‚  TrailingStopManager                                    â”‚
â”‚    â””â”€â–º Dynamic SL Adjustment (1.5%)                     â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATA LAYER                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  KlinesOrchestrator                                     â”‚
â”‚    â”œâ”€â–º RateLimitManager (<1200 req/min)                 â”‚
â”‚    â”œâ”€â–º KlinesFetcher (Binance API)                      â”‚
â”‚    â”œâ”€â–º KlineValidator (Integrity Checks)                â”‚
â”‚    â””â”€â–º KlinesCache (SQLite + Parquet)                   â”‚
â”‚                                                         â”‚
â”‚  TreasuryManager                                        â”‚
â”‚    â”œâ”€â–º Capital Tracking                                â”‚
â”‚    â”œâ”€â–º Margin Calculation                              â”‚
â”‚    â””â”€â–º Circuit Breaker Logic                            â”‚
â”‚                                                         â”‚
â”‚  Backtester                                             â”‚
â”‚    â”œâ”€â–º OHLC Bar Replay (Deterministic)                  â”‚
â”‚    â”œâ”€â–º Metrics Calculation (Sharpe, MaxDD, Calmar)      â”‚
â”‚    â””â”€â–º Report Generation (Equity Curve)                 â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## NÃ­vel 4: CÃ³digo (Class Diagrams & Data Flows)

### Position Management Flow

```python
Signal (detected)
  â”‚
  â”œâ”€â–º RiskGates.validate(signal)
  â”‚     â”œâ”€â–º check_capital_available()
  â”‚     â”œâ”€â–º check_leverage_limit(3.0)
  â”‚     â”œâ”€â–º check_portfolio_drawdown(-5%)
  â”‚     â””â”€â–º return GO / NO-GO
  â”‚
  â”œâ”€â–º [IF GO]
  â”‚     â”‚
  â”‚     â”œâ”€â–º OrderExecutor.place_order(symbol, qty, entry_price)
  â”‚     â”‚     â””â”€â–º Binance API: POST /fapi/v1/order
  â”‚     â”‚
  â”‚     â”œâ”€â–º PositionManager.new_position(order_id, symbol, qty, entry)
  â”‚     â”‚     â”œâ”€â–º Create Position object
  â”‚     â”‚     â”œâ”€â–º Set SL = entry Ã— 0.98 (2% below)
  â”‚     â”‚     â”œâ”€â–º Set TP = entry Ã— 1.06 (6% above)
  â”‚     â”‚     â””â”€â–º Store in portfolio
  â”‚     â”‚
  â”‚     â””â”€â–º [EVERY 1H]
  â”‚           â”‚
  â”‚           â”œâ”€â–º TrailingStopManager.adjust_stop(position)
  â”‚           â”‚     â””â”€â–º New SL = max(current SL, high Ã— 0.985)
  â”‚           â”‚
  â”‚           â”œâ”€â–º Monitor for exit signals (SL/TP hit)
  â”‚           â”‚
  â”‚           â””â”€â–º [IF EXIT SIGNAL]
  â”‚                 â”‚
  â”‚                 â”œâ”€â–º OrderExecutor.place_exit_order(position)
  â”‚                 â”‚
  â”‚                 â”œâ”€â–º PositionManager.close_position(position)
  â”‚                 â”‚     â”œâ”€â–º Calculate realized P&L
  â”‚                 â”‚     â”œâ”€â–º Update TreasuryManager
  â”‚                 â”‚     â””â”€â–º Log trade to history
  â”‚                 â”‚
  â”‚                 â””â”€â–º Position marked CLOSED
  â”‚
  â””â”€â–º [IF NO-GO]
        â””â”€â–º Signal ignored, no order placed
```

### Data Sync Flow (Issue #67)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Binance Futures API  â”‚
â”‚ /fapi/v1/klines     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ (4h candles)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RateLimitManager     â”‚
â”‚ <1200 req/min        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KlinesFetcher        â”‚
â”‚ Batch: 1500 candles  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KlineValidator       â”‚
â”‚ â€¢ Price order check  â”‚
â”‚ â€¢ Trades > 0         â”‚
â”‚ â€¢ No duplicates      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SQLite Cache     â”‚  â”‚ Parquet      â”‚
â”‚ (Hot Data)       â”‚  â”‚ (Snapshots)  â”‚
â”‚ 650 KB           â”‚  â”‚ 580 KB       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â””â”€â–º <100ms read latency âœ…
```

---

## DecisÃµes de Arquitetura Documentadas

| DecisÃ£o | Rationale | Trade-offs |
|---------|-----------|-----------|
| **4h Candlesticks** | Balance: granularidade + profundidade 1Y | â†” FrequÃªncia menor que intraday |
| **SQLite + Parquet** | Hot (SQL) + Cold (columnnar) storage | â†” Dupla manutenÃ§Ã£o |
| **LIFO Position Management** | Fair+ determinÃ­stico | â†” Menos controle granular |
| **3Ã— Max Leverage** | Risk tolerance | â†” Menor upside |
| **Paper + Live Modes** | Praticar antes de produÃ§Ã£o | â†” Code duplication |

---

## ReferÃªncias

- [DECISIONS.md](DECISIONS.md) â€” ADRs formalizadas
- [architecture.md](architecture.md) â€” Design detalhado
- [data_models.md](data_models.md) â€” ORM + Schemas

