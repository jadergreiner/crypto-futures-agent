#!/bin/bash
# PRE-COMMIT HOOK ‚Äî DOC GOVERNANCE (21 FEV 2026)
# Valida markdown + docstrings ANTES de permitir commit
# Run: chmod +x .githooks/pre-commit && git config core.hooksPath .githooks

set -e

echo "üîç PRE-COMMIT: Validando documenta√ß√£o..."

# 1. MARKDOWNLINT ‚Äî Verifica .md files
echo "  ‚îú‚îÄ Executando markdownlint..."
if command -v markdownlint &> /dev/null; then
    # Verifica apenas arquivos staged
    STAGED_MDS=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' || true)

    if [ -n "$STAGED_MDS" ]; then
        if ! markdownlint $STAGED_MDS 2>&1 | grep -q "passed"; then
            echo "  ‚ùå Markdownlint falhou!"
            echo "     Corrija os erros de markdown antes de commitar."
            .markdownlintrc.json para regras (80 chars, UTF-8, code blocks)."
            exit 1
        fi
        echo "  ‚úÖ Markdownlint: OK ($STAGED_MDS)"
    fi
else
    echo "  ‚ö†Ô∏è  markdownlint n√£o encontrado. Install: npm install -g markdownlint-cli"
fi

# 2. PYTHON DOCSTRING CHECKER ‚Äî Verifica docstrings em Python
echo "  ‚îú‚îÄ Executando docstring checker..."
STAGED_PYS=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -n "$STAGED_PYS" ]; then
    for pyfile in $STAGED_PYS; do
        # Skip test files e scripts auxiliares
        if [[ $pyfile == *"test"* ]] || [[ $pyfile == *"check"* ]] || [[ $pyfile == *"diagnostico"* ]]; then
            continue
        fi

        # Se √© arquivo em agent/, execution/, risk/, backtest/ ‚Äî requer docstring
        if [[ $pyfile == agent/* ]] || [[ $pyfile == execution/* ]] || [[ $pyfile == risk/* ]] || [[ $pyfile == backtest/* ]]; then
            # Simples check: arquivo tem pelo menos 10 linhas? Se sim, primeira linha deve ter docstring
            lines=$(wc -l < "$pyfile")
            if [ "$lines" -gt 10 ]; then
                head -n 5 "$pyfile" | grep -q '"""' || {
                    echo "  ‚ùå Docstring faltando: $pyfile"
                    echo "     Adicione docstring no in√≠cio do arquivo (ex: \"\"\"Descri√ß√£o do m√≥dulo.\"\"\")"
                    exit 1
                }
            fi
        fi
    done
    echo "  ‚úÖ Docstring checker: OK ($STAGED_PYS)"
fi

# 3. ENCODING CHECK ‚Äî Valida UTF-8 v√°lido
echo "  ‚îú‚îÄ Verificando encoding UTF-8..."
for file in $(git diff --cached --name-only --diff-filter=ACM); do
    if file "$file" | grep -q "text"; then
        if ! iconv -f UTF-8 -t UTF-8 "$file" > /dev/null 2>&1; then
            echo "  ‚ùå Encoding inv√°lido: $file (n√£o √© UTF-8 v√°lido)"
            exit 1
        fi
    fi
done
echo "  ‚úÖ Encoding: OK (UTF-8 v√°lido)"

# 4. SYNC TAG CHECK (WARN) ‚Äî Alerta se c√≥digo cr√≠tico muda sem [SYNC]
echo "  ‚îú‚îÄ Verificando [SYNC] tag para mudan√ßas cr√≠ticas..."
COMMIT_MSG=$(git diff --cached --diff-filter=ACM --name-only | grep -E '(docs/|README|BEST_PRACTICES)' || true)

if [ -n "$COMMIT_MSG" ]; then
    echo "  ‚ö†Ô∏è  Detectado mudan√ßa em docs cr√≠ticas."
    echo "     Certifique-se de usar [SYNC] tag no commit message."
    echo "     Exemplo: [SYNC] Atualizado docs/ARCHITECTURE.md ‚Äî heur√≠stica v2"
fi

echo "‚úÖ PRE-COMMIT VALIDA√á√ÉO COMPLETA"
exit 0
