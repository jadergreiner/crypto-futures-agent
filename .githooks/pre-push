#!/bin/bash
# PRE-PUSH HOOK ‚Äî DOC GOVERNANCE (21 FEV 2026)
# Valida que PR ter√° [SYNC] tag se docs foram alteradas
# Run: chmod +x .githooks/pre-push && git config core.hooksPath .githooks

echo "üîç PRE-PUSH: Verificando conformidade [SYNC] tag..."

# Pega commits que s√£o diferentes de origin/main
COMMITS=$(git rev-list origin/main..HEAD 2>/dev/null || git rev-list HEAD~1..HEAD)

# Verifica cada commit
for commit in $COMMITS; do
    MSG=$(git log -1 --format=%B $commit)

    # Se commit alterou arquivos cr√≠ticos
    CHANGED_CRITICAL=$(git diff-tree --no-commit-id --name-only -r $commit | \
        grep -E '(^docs/|^README|^BEST_PRACTICES|^\.github)' || true)

    if [ -n "$CHANGED_CRITICAL" ]; then
        # Valida que msg tem [SYNC] tag
        if ! echo "$MSG" | grep -q "\[SYNC\]"; then
            echo "‚ö†Ô∏è  AVISO: Mudan√ßas em arquivos cr√≠ticos detectadas:"
            echo "   Arquivos: $CHANGED_CRITICAL"
            echo "   Commit: $commit"
            echo ""
            echo "‚ùå Sua mensagem de commit N√ÉO cont√©m [SYNC] tag."
            echo "   Tag [SYNC] √© obrigat√≥ria para mudan√ßas em docs cr√≠ticas."
            echo ""
            echo "   CORRIGIR:"
            echo "   $ git commit --amend -m \"[SYNC] Sua mensagem ‚Äî docs atualizadas\""
            echo "   $ git push"
            exit 1
        fi
    fi
done

echo "‚úÖ PRE-PUSH VALIDA√á√ÉO COMPLETA ([SYNC] tags OK)"
exit 0
